<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>LSDSNG â†’ HTML / JSON / MIDI</title>
</head>
<body>
  <p>
    Convert your LSDSNG data to HTML, JSON, or MIDI.
    <br><br>
    Choose a <code>.lsdsng</code> or <code>.lsdprj</code> file, select output type, and click Convert.
  </p>

  <form id="uploadForm">
    <p>
      <input type="file" id="file" name="upload" accept=".lsdsng,.lsdprj">
    </p>
    <p>
      <input type="radio" id="htmlradio" name="output" value="html" checked>
      <label for="htmlradio">HTML</label>
      <input type="radio" id="jsonradio" name="output" value="json">
      <label for="jsonradio">JSON</label>
      <input type="radio" id="midiradio" name="output" value="midi">
      <label for="midiradio">MIDI</label>
    </p>
    <p>
      <input type="submit" id="submit" value="Convert">
    </p>
  </form>

  <!-- load your conversion code -->
  <script src="lsdsng.js"></script>

  <script>
    document.getElementById("uploadForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const fileInput = document.getElementById("file");
      if (!fileInput.files.length) {
        alert("Please select a file first.");
        return;
      }

      const outputType = document.querySelector('input[name="output"]:checked').value;
      const file = fileInput.files[0];
      const arrayBuffer = await file.arrayBuffer();

      // Call your unpack function
      const data = window.unpack(new Uint8Array(arrayBuffer));

      let blob, filename;
      if (outputType === "html") {
        const html = window.makeHTML(data);
        blob = new Blob([html], { type: "text/html" });
        filename = file.name.replace(/\.(lsdsng|lsdprj)$/i, "") + ".html";
      } else if (outputType === "json") {
        const json = JSON.stringify(data, null, 2);
        blob = new Blob([json], { type: "application/json" });
        filename = file.name.replace(/\.(lsdsng|lsdprj)$/i, "") + ".json";
      } else if (outputType === "midi") {
        const midiData = window.makeMIDI(data); // should return Uint8Array or ArrayBuffer
        blob = new Blob([midiData], { type: "audio/midi" });
        filename = file.name.replace(/\.(lsdsng|lsdprj)$/i, "") + ".mid";
      }

      // Trigger download
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });
  </script>
</body>
</html>
